name: Feed deploy_tmp on promotion (DEVâ†’QUA & QUAâ†’PRD)

on:
  pull_request:
    branches:
      - QUA
      - PRD
    types:
      - closed

jobs:
  feed-buffer:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
    - name: Checkout target branch (base)
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.base.ref }}
        fetch-depth: 0   # âœ… important pour voir l'historique complet

    - name: Detect promotion type
      id: detect
      shell: bash
      run: |
        SOURCE="${{ github.event.pull_request.head.ref }}"
        TARGET="${{ github.event.pull_request.base.ref }}"

        echo "SOURCE=$SOURCE"
        echo "TARGET=$TARGET"

        if [[ "$SOURCE" == "DEV" && "$TARGET" == "QUA" ]]; then
          echo "MODE=DEV_TO_QUA" >> "$GITHUB_OUTPUT"
        elif [[ "$SOURCE" == "QUA" && "$TARGET" == "PRD" ]]; then
          echo "MODE=QUA_TO_PRD" >> "$GITHUB_OUTPUT"
        else
          echo "MODE=UNSUPPORTED" >> "$GITHUB_OUTPUT"
        fi

    - name: Feed deploy_tmp.txt with all EXECUTEs from PR
      if: steps.detect.outputs.MODE != 'UNSUPPORTED'
      shell: bash
      run: |
        MODE="${{ steps.detect.outputs.MODE }}"
        echo "Promotion mode: $MODE"

        touch deploy_tmp.txt

        echo "ðŸ”Ž Existing deploy_tmp.txt (before):"
        cat deploy_tmp.txt || echo "(empty)"

        if [[ "$MODE" == "DEV_TO_QUA" ]]; then
          echo "âž¡ï¸ DEV â†’ QUA : aggregating EXECUTE from all commits in PR (deploy.txt)"

          BASE_SHA="${{ github.event.pull_request.base.sha }}"
          HEAD_SHA="${{ github.event.pull_request.head.sha }}"

          # On rÃ©cupÃ¨re tous les commits de la PR qui touchent deploy.txt, dans l'ordre chronologique
          git fetch origin
          COMMITS=$(git log --reverse --pretty=format:%H "${BASE_SHA}..${HEAD_SHA}" -- deploy.txt || true)

          > new_buffer.txt

          for c in $COMMITS; do
            echo "  ðŸ”¹ Reading deploy.txt at commit $c"
            git show "${c}:deploy.txt" 2>/dev/null \
              | grep -E '^EXECUTE[[:space:]]+' \
              | sed 's/^EXECUTE[[:space:]]\+//' \
              >> new_buffer.txt || true
          done

          echo "ðŸ”Ž New entries collected from PR:"
          cat new_buffer.txt || echo "(none)"

          # Concat ancien buffer + nouvelles entrÃ©es, puis dÃ©dup SANS casser l'ordre
          cat deploy_tmp.txt new_buffer.txt > merged_buffer.txt
          awk '!seen[$0]++' merged_buffer.txt | sed '/^$/d' > deploy_tmp.txt

        elif [[ "$MODE" == "QUA_TO_PRD" ]]; then
          echo "âž¡ï¸ QUA â†’ PRD : copying QUA/deploy_tmp.txt as is (order preserved)"

          git fetch origin QUA
          git checkout origin/QUA -- deploy_tmp.txt

          # Nettoyage lÃ©ger des lignes vides (ordre conservÃ©)
          awk 'NF>0' deploy_tmp.txt > deploy_tmp_clean.txt
          mv deploy_tmp_clean.txt deploy_tmp.txt
        fi

        echo "ðŸ”Ž deploy_tmp.txt (after):"
        cat deploy_tmp.txt || echo "(empty)"

    - name: Commit deploy_tmp.txt
      if: steps.detect.outputs.MODE != 'UNSUPPORTED'
      shell: bash
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"

        git add deploy_tmp.txt
        git commit -m "Feed deploy_tmp from PR (EXECUTE, order preserved)" || echo "No changes to commit"
        git push origin "${{ github.event.pull_request.base.ref }}"
