name: Feed deploy_tmp on promotion (DEV→QUA & QUA→PRD)

on:
  pull_request:
    branches:
      - QUA
      - PRD
    types:
      - closed

jobs:
  feed-buffer:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
    - name: Checkout target branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.base.ref }}

    - name: Detect promotion type
      id: detect
      shell: bash
      run: |
        SOURCE="${{ github.event.pull_request.head.ref }}"
        TARGET="${{ github.event.pull_request.base.ref }}"

        if [[ "$SOURCE" == "DEV" && "$TARGET" == "QUA" ]]; then
          echo "MODE=DEV_TO_QUA" >> "$GITHUB_OUTPUT"
        elif [[ "$SOURCE" == "QUA" && "$TARGET" == "PRD" ]]; then
          echo "MODE=QUA_TO_PRD" >> "$GITHUB_OUTPUT"
        else
          echo "MODE=UNSUPPORTED" >> "$GITHUB_OUTPUT"
        fi

    - name: Feed deploy_tmp.txt (EXECUTE only)
      if: steps.detect.outputs.MODE != 'UNSUPPORTED'
      shell: bash
      run: |
        MODE="${{ steps.detect.outputs.MODE }}"
        echo "Promotion mode: $MODE"

        touch deploy_tmp.txt

        if [[ "$MODE" == "DEV_TO_QUA" ]]; then
          echo "➡️ DEV → QUA : reading EXECUTE lines from deploy.txt"

          git fetch origin DEV
          git checkout origin/DEV -- deploy.txt

          grep -E '^EXECUTE[[:space:]]+' deploy.txt \
            | sed 's/^EXECUTE[[:space:]]\+//' \
            >> deploy_tmp.txt

        elif [[ "$MODE" == "QUA_TO_PRD" ]]; then
          echo "➡️ QUA → PRD : propagating deploy_tmp.txt"

          git fetch origin QUA
          git checkout origin/QUA -- deploy_tmp.txt

          awk '!seen[$0]++' deploy_tmp.txt | sed '/^$/d' > deploy_tmp_clean.txt
          mv deploy_tmp_clean.txt deploy_tmp.txt
          exit 0
        fi

        # ✅ Nettoyage final (doublons + lignes vides)
        sort -u deploy_tmp.txt | sed '/^$/d' > deploy_tmp_clean.txt
        mv deploy_tmp_clean.txt deploy_tmp.txt

    - name: Commit deploy_tmp.txt
      if: steps.detect.outputs.MODE != 'UNSUPPORTED'
      shell: bash
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"

        git add deploy_tmp.txt
        git commit -m "Feed deploy_tmp with EXECUTE objects only" || echo "No changes to commit"
        git push origin "${{ github.event.pull_request.base.ref }}"
