name: Feed deploy_tmp on promotion (DEVâ†’QUA & QUAâ†’PRD)

on:
  pull_request:
    branches:
      - QUA
      - PRD
    types:
      - closed

jobs:
  feed-buffer:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest

    steps:
    - name: Checkout target branch
      uses: actions/checkout@v4
      with:
        ref: ${{ github.event.pull_request.base.ref }}

    - name: Detect promotion type
      id: detect
      shell: bash
      run: |
        SOURCE="${{ github.event.pull_request.head.ref }}"
        TARGET="${{ github.event.pull_request.base.ref }}"

        echo "SOURCE=$SOURCE"
        echo "TARGET=$TARGET"

        if [[ "$SOURCE" == "DEV" && "$TARGET" == "QUA" ]]; then
          echo "MODE=DEV_TO_QUA" >> "$GITHUB_OUTPUT"
        elif [[ "$SOURCE" == "QUA" && "$TARGET" == "PRD" ]]; then
          echo "MODE=QUA_TO_PRD" >> "$GITHUB_OUTPUT"
        else
          echo "MODE=UNSUPPORTED" >> "$GITHUB_OUTPUT"
        fi

    - name: Feed deploy_tmp.txt with order preserved
      if: steps.detect.outputs.MODE != 'UNSUPPORTED'
      shell: bash
      run: |
        MODE="${{ steps.detect.outputs.MODE }}"
        echo "Promotion mode: $MODE"

        # On travaille toujours sur le buffer de la branche cible (QUA ou PRD)
        touch deploy_tmp.txt

        echo "ðŸ”Ž Existing deploy_tmp.txt (before):"
        cat deploy_tmp.txt || echo "(empty)"

        if [[ "$MODE" == "DEV_TO_QUA" ]]; then
          echo "âž¡ï¸ DEV â†’ QUA : reading EXECUTE lines from DEV/deploy.txt"

          # RÃ©cupÃ©rer le deploy.txt de DEV
          git fetch origin DEV
          git checkout origin/DEV -- deploy.txt

          # 1) ancien buffer (ordre existant)
          cp deploy_tmp.txt old_buffer.txt

          # 2) nouvelles lignes provenant de deploy.txt (EXECUTE uniquement, sans le mot EXECUTE)
          grep -E '^EXECUTE[[:space:]]+' deploy.txt \
            | sed 's/^EXECUTE[[:space:]]\+//' \
            > new_buffer.txt

          echo "ðŸ”Ž New entries from DEV/deploy.txt:"
          cat new_buffer.txt || echo "(none)"

          # 3) concat : ancien contenu puis nouveau, en gardant le 1er ordre
          cat old_buffer.txt new_buffer.txt > merged_buffer.txt

          # 4) dÃ©duplication SANS casser lâ€™ordre : on garde la 1Ê³áµ‰ occurrence
          awk '!seen[$0]++' merged_buffer.txt | sed '/^$/d' > deploy_tmp.txt

        elif [[ "$MODE" == "QUA_TO_PRD" ]]; then
          echo "âž¡ï¸ QUA â†’ PRD : copying QUA/deploy_tmp.txt as is (order preserved)"

          # On rÃ©cupÃ¨re simplement le buffer QUA tel quel, sans le modifier
          git fetch origin QUA
          git checkout origin/QUA -- deploy_tmp.txt

          # (Ã©ventuel nettoyage des lignes vides, sans toucher Ã  lâ€™ordre)
          awk 'NF>0' deploy_tmp.txt > deploy_tmp_clean.txt
          mv deploy_tmp_clean.txt deploy_tmp.txt
        fi

        echo "ðŸ”Ž deploy_tmp.txt (after):"
        cat deploy_tmp.txt || echo "(empty)"

    - name: Commit deploy_tmp.txt
      if: steps.detect.outputs.MODE != 'UNSUPPORTED'
      shell: bash
      run: |
        git config user.name "github-actions"
        git config user.email "github-actions@github.com"

        git add deploy_tmp.txt
        git commit -m "Feed deploy_tmp on promotion (order preserved)" || echo "No changes to commit"
        git push origin "${{ github.event.pull_request.base.ref }}"
