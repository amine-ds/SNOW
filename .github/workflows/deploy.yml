name: Deploy 

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "QUA"
        type: choice
        options:
          - DEV
          - QUA
          - PRD

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Snowflake Python Connector
      run: |
        python -m pip install --upgrade pip
        pip install snowflake-connector-python

    - name: Deploy with automatic ENV & WAREHOUSE mapping
      env:
        SF_ACCOUNT: ${{ secrets.SF_ACCOUNT }}
        SF_USER: ${{ secrets.SF_USER }}
        SF_PASSWORD: ${{ secrets.SF_PASSWORD }}
        TARGET_ENV: ${{ github.event.inputs.environment }}
      run: |
        python <<EOF
        import snowflake.connector
        import os
        import sys

        # âœ… Mapping Environnement â†’ Base + Warehouse
        ENV_MAPPING = {
            "DEV": {
                "db_from": "DEV_EMEA",
                "db_to": "DEV_EMEA",
                "wh_to": "DEV_DATA"
            },
            "QUA": {
                "db_from": "DEV_EMEA",
                "db_to": "QUA_EMEA",
                "wh_to": "QUA_DATA"
            },
            "PRD": {
                "db_from": "DEV_EMEA",
                "db_to": "PRD_EMEA",
                "wh_to": "PRD_DATA"
            }
        }

        target_env = os.environ["TARGET_ENV"]
        env_conf = ENV_MAPPING.get(target_env)

        if not env_conf:
            print("âŒ Invalid environment")
            sys.exit(1)

        print(f"ðŸŽ¯ Target ENV : {target_env}")
        print(f"ðŸŽ¯ Database   : {env_conf['db_to']}")
        print(f"ðŸŽ¯ Warehouse  : {env_conf['wh_to']}")

        ctx = snowflake.connector.connect(
            user=os.environ["SF_USER"],
            password=os.environ["SF_PASSWORD"],
            account=os.environ["SF_ACCOUNT"],
            role="SYSADMIN"
        )

        cs = ctx.cursor()
        failed = False

        try:
            # âœ… Contexte cible
            cs.execute(f"USE DATABASE {env_conf['db_to']}")
            cs.execute("USE SCHEMA SILV")

            # âœ… Lecture du fichier deploy.txt
            if not os.path.exists("deploy.txt"):
                print("âŒ deploy.txt file not found")
                sys.exit(1)

            with open("deploy.txt", "r") as f:
                files = [line.strip() for line in f if line.strip()]

            print("ðŸ“¦ Objects selected for deployment:")
            for f in files:
                print("  -", f)

            for file in files:
                path = f"TABLE/{file}"

                if not os.path.exists(path):
                    print(f"âŒ Missing file: {path}")
                    failed = True
                    continue

                print(f"\nðŸš€ Deploying {path}")

                with open(path, "r") as sql_file:
                    sql = sql_file.read()

                # âœ… REMPLACEMENTS AUTOMATIQUES
                sql = sql.replace(env_conf["db_from"], env_conf["db_to"])
                sql = sql.replace("warehouse = DEV_DATA", f"warehouse = {env_conf['wh_to']}")

                try:
                    cs.execute(sql)
                    print("âœ… SUCCESS")
                except Exception as e:
                    print("âŒ FAILED:", str(e))
                    failed = True

            if failed:
                print("\nâŒ Deployment finished with ERRORS")
                sys.exit(1)
            else:
                print("\nâœ… Deployment finished SUCCESSFULLY")

        finally:
            cs.close()
            ctx.close()
        EOF
