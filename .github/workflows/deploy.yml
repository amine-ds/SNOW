name: Deploy 

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: "QUA"
        type: choice
        options:
          - DEV
          - QUA
          - PRD

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Snowflake Python Connector
      run: |
        python -m pip install --upgrade pip
        pip install snowflake-connector-python

    - name: Deploy selected objects (multi folders + warehouse replace)
      env:
        SF_ACCOUNT: ${{ secrets.SF_ACCOUNT }}
        SF_USER: ${{ secrets.SF_USER }}
        SF_PASSWORD: ${{ secrets.SF_PASSWORD }}
        TARGET_ENV: ${{ github.event.inputs.environment }}
      run: |
        python <<EOF
        import snowflake.connector
        import os
        import sys
    
        target_env = os.environ["TARGET_ENV"]
    
        ENV_MAPPING = {
            "DEV": {"db": "DEV_EMEA", "wh": "DEV_DATA"},
            "QUA": {"db": "QUA_EMEA", "wh": "QUA_DATA"},
            "PRD": {"db": "PRD_EMEA", "wh": "PRD_DATA"},
        }
    
        env_conf = ENV_MAPPING.get(target_env)
    
        if not env_conf:
            print("âŒ Invalid environment")
            sys.exit(1)
    
        print(f"ðŸŽ¯ Target ENV : {target_env}")
        print(f"ðŸŽ¯ Database   : {env_conf['db']}")
        print(f"ðŸŽ¯ Warehouse  : {env_conf['wh']}")
    
        ctx = snowflake.connector.connect(
            user=os.environ["SF_USER"],
            password=os.environ["SF_PASSWORD"],
            account=os.environ["SF_ACCOUNT"],
            role="SYSADMIN"
        )
    
        cs = ctx.cursor()
        failed = False
    
        OBJECT_FOLDERS = [
            "TABLE",
            "DYNAMIC_TABLE",
            "VIEW",
            "STORED_PROCEDURE"
        ]
    
        try:
            # âœ… CONTEXTE
            cs.execute(f"USE DATABASE {env_conf['db']}")
            cs.execute("USE SCHEMA SILV")
    
            # âœ… LECTURE deploy.txt
            if not os.path.exists("deploy.txt"):
                print("âŒ deploy.txt file not found")
                sys.exit(1)
    
            with open("deploy.txt", "r") as f:
                objects = [line.strip() for line in f if line.strip()]
    
            print("ðŸ“¦ Objects selected for deployment:")
            for obj in objects:
                print("  -", obj)
    
            for obj in objects:
                found = False
    
                for folder in OBJECT_FOLDERS:
                    path = f"{folder}/{obj}"
    
                    if os.path.exists(path):
                        found = True
                        print(f"\nðŸš€ Deploying {path}")
    
                        with open(path, "r") as sql_file:
                            sql = sql_file.read()
    
                        # âœ…âœ…âœ… REMPLACEMENT AUTOMATIQUE DU WAREHOUSE POUR LES DYNAMIC TABLES
                        sql = sql.replace("warehouse = DEV_DATA", f"warehouse = {env_conf['wh']}")
                        sql = sql.replace("WAREHOUSE = DEV_DATA", f"WAREHOUSE = {env_conf['wh']}")
    
                        # âœ… (Optionnel mais recommandÃ©) Remplacement DB si jamais elle est encore en dur
                        sql = sql.replace("DEV_EMEA", env_conf["db"])
    
                        try:
                            cs.execute(sql)
                            print("âœ… SUCCESS")
                        except Exception as e:
                            print("âŒ FAILED:", str(e))
                            failed = True
    
                        break
    
                if not found:
                    print(f"âŒ Missing file in all known folders: {obj}")
                    failed = True
    
            if failed:
                print("\nâŒ Deployment finished with ERRORS")
                sys.exit(1)
            else:
                print("\nâœ… Deployment finished SUCCESSFULLY")
    
        finally:
            cs.close()
            ctx.close()
        EOF
    
        
