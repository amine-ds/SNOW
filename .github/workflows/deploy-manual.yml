name: Deploy Snowflake Objects (Manual + Multi-Env)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target database"
        required: true
        default: "QUA_EMEA"
        type: choice
        options:
          - DEV_EMEA
          - QUA_EMEA
          - PRD_EMEA

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # âœ… 1. Checkout du repo
    - name: Checkout repository
      uses: actions/checkout@v4

    # âœ… 2. Installation du connecteur Snowflake Python
    - name: Install Snowflake Python Connector
      run: |
        python -m pip install --upgrade pip
        pip install snowflake-connector-python

    # âœ… 3. DÃ©ploiement des objets listÃ©s dans deploy.txt
    - name: Deploy selected objects
      env:
        SF_ACCOUNT: ${{ secrets.SF_ACCOUNT }}
        SF_USER: ${{ secrets.SF_USER }}
        SF_PASSWORD: ${{ secrets.SF_PASSWORD }}
        TARGET_DB: ${{ github.event.inputs.environment }}
      run: |
        python <<EOF
        import snowflake.connector
        import os
        import sys

        target_db = os.environ["TARGET_DB"]

        print(f"ðŸŽ¯ Target database: {target_db}")

        ctx = snowflake.connector.connect(
            user=os.environ["SF_USER"],
            password=os.environ["SF_PASSWORD"],
            account=os.environ["SF_ACCOUNT"],
            role="SYSADMIN"
        )

        cs = ctx.cursor()
        failed = False

        try:
            # âœ… Contexte dynamique
            cs.execute(f"USE DATABASE {target_db}")
            cs.execute("USE SCHEMA SILV")

            # âœ… Lecture du fichier deploy.txt
            if not os.path.exists("deploy.txt"):
                print("âŒ deploy.txt file not found")
                sys.exit(1)

            with open("deploy.txt", "r") as f:
                files = [line.strip() for line in f if line.strip()]

            print("ðŸ“¦ Objects selected for deployment:")
            for f in files:
                print("  -", f)

            for file in files:
                path = f"TABLE/{file}"

                if not os.path.exists(path):
                    print(f"âŒ Missing file: {path}")
                    failed = True
                    continue

                print(f"\nðŸš€ Deploying {path}")

                with open(path, "r") as sql_file:
                    sql = sql_file.read()

                try:
                    cs.execute(sql)
                    print("âœ… SUCCESS")
                except Exception as e:
                    print("âŒ FAILED:", str(e))
                    failed = True

            if failed:
                print("\nâŒ Deployment finished with ERRORS")
                sys.exit(1)
            else:
                print("\nâœ… Deployment finished SUCCESSFULLY")

        finally:
            cs.close()
            ctx.close()
        EOF
