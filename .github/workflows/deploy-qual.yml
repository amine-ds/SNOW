name: Deploy Snowflake Tables to QUAL (Python)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    # âœ… 1. RÃ©cupÃ©ration du code depuis GitHub
    - name: Checkout repository
      uses: actions/checkout@v4

    # âœ… 2. Installation de Python et du connecteur Snowflake
    - name: Install Python & Snowflake Connector
      run: |
        python -m pip install --upgrade pip
        pip install snowflake-connector-python

    # âœ… 3. DÃ©ploiement des tables dans Snowflake QUAL
    - name: Deploy tables to QUAL
      env:
        SF_ACCOUNT: ${{ secrets.SF_ACCOUNT }}
        SF_USER: ${{ secrets.SF_USER }}
        SF_PASSWORD: ${{ secrets.SF_PASSWORD }}
      run: |
        python <<EOF
        import snowflake.connector
        import glob
        import os

        # âœ… Connexion Snowflake
        ctx = snowflake.connector.connect(
            user=os.environ["SF_USER"],
            password=os.environ["SF_PASSWORD"],
            account=os.environ["SF_ACCOUNT"],
            role="SYSADMIN"
        )

        cs = ctx.cursor()

        try:
            # âœ… Contexte obligatoire (corrige ton erreur actuelle)
            cs.execute("USE DATABASE QUAL_EMEA")
            cs.execute("USE SCHEMA SILV")
            cs.execute("USE WAREHOUSE COMPUTE_WH")

            # âœ… DÃ©ploiement automatique de tous les fichiers SQL
            for file in glob.glob("TABLE/*.sql"):
                print(f"ðŸš€ Deploying {file}")
                with open(file, "r") as f:
                    sql = f.read()
                    cs.execute(sql)

            print("âœ… All tables deployed successfully")

        finally:
            cs.close()
            ctx.close()
        EOF
